<script>
  const preguntas = [
    { clave: 'edad', texto: '¿Cuál es tu edad?' },
    { clave: 'embarazo', texto: '¿Estás embarazada?', opciones: ['sí', 'no'] },
    { clave: 'condiciones', texto: '¿Tienes alguna condición médica (ej. diabetes, resistencia a la insulina)?' },
    { clave: 'objetivo', texto: '¿Cuál es tu objetivo principal con Chipiti?' },
    { clave: 'alimentos', texto: '¿Qué alimentos te gustaría consultar o evitar?' }
  ];

  let respuestas = {};
  let paso = 0;

  function mostrarPregunta() {
    const contenedor = document.getElementById('entrevista');
    contenedor.innerHTML = '';
    const pregunta = preguntas[paso];

    const label = document.createElement('label');
    label.textContent = pregunta.texto;

    const input = pregunta.opciones ? document.createElement('select') : document.createElement('input');
    input.className = 'campo';

    if (pregunta.opciones) {
      pregunta.opciones.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        input.appendChild(option);
      });
    }

    const boton = document.createElement('button');
    boton.textContent = 'Siguiente';
    boton.onclick = () => {
      respuestas[pregunta.clave] = input.value;
      paso++;
      if (paso < preguntas.length) {
        mostrarPregunta();
      } else {
        generarPerfil();
      }
    };

    contenedor.appendChild(label);
    contenedor.appendChild(document.createElement('br'));
    contenedor.appendChild(input);
    contenedor.appendChild(document.createElement('br'));
    contenedor.appendChild(boton);
  }

  function generarPerfil() {
    const perfil = {
      ...respuestas,
      componentes: []
    };

    if (respuestas.embarazo === 'sí') {
      perfil.componentes.push({
        tipo: 'campo_texto',
        nombre: 'Consulta de alimentos seguros en el embarazo',
        placeholder: 'Ej. queso feta, salmón, jamón serrano',
        accion: 'consultar_alimento'
      });
    }

    if (respuestas.condiciones.toLowerCase().includes('glucosa') || respuestas.objetivo.includes('glucosa')) {
      perfil.componentes.push({
        tipo: 'campo_texto',
        nombre: 'Consulta alimentos y su impacto en glucosa',
        placeholder: 'Ej. avena, mango, arroz',
        accion: 'consultar_glucosa'
      });
    }

    perfil.componentes.push({
      tipo: 'campo_texto',
      nombre: '¿Qué te gustaría comer hoy?',
      placeholder: 'Ej. algo fresco, sin lácteos',
      accion: 'sugerir_menu'
    });

    // Guardar en localStorage
    localStorage.setItem('perfilChipiti', JSON.stringify(perfil));
    mostrarCampos(perfil);
  }

  function mostrarCampos(perfil) {
    document.getElementById('entrevista').style.display = 'none';
    document.getElementById('perfilFinal').style.display = 'block';
    document.getElementById('jsonOutput').textContent = JSON.stringify(perfil, null, 2);

    const contenedor = document.getElementById('camposDinamicos');
    contenedor.innerHTML = '';
    perfil.componentes.forEach(campo => {
      const div = document.createElement('div');
      div.className = 'campo';

      const label = document.createElement('label');
      label.textContent = campo.nombre;

      const input = document.createElement('input');
      input.placeholder = campo.placeholder || '';

      div.appendChild(label);
      div.appendChild(document.createElement('br'));
      div.appendChild(input);
      contenedor.appendChild(div);
    });
  }

  // Verificar si ya hay un perfil guardado
window.addEventListener('DOMContentLoaded', () => {
    const perfilGuardado = localStorage.getItem('perfilChipiti');
    if (perfilGuardado) {
      mostrarCampos(JSON.parse(perfilGuardado));
    } else {
      mostrarPregunta();
    }
  };
</script>
